apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-collector
spec:
  schedule: {{ .Values.collector.schedule | quote }}
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: collector
              image: {{ .Values.collector.image }}
              imagePullPolicy: {{ .Values.collector.imagePullPolicy }}
              env:
                - name: TENANT_ID
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "sharing-audit.secretName" . }}
                      key: tenant-id
                - name: CLIENT_ID
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "sharing-audit.secretName" . }}
                      key: client-id
                - name: CLIENT_SECRET
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "sharing-audit.secretName" . }}
                      key: client-secret
                - name: NEO4J_URI
                  value: bolt://{{ .Release.Name }}-neo4j:7687
                - name: NEO4J_USER
                  value: neo4j
                - name: NEO4J_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "sharing-audit.secretName" . }}
                      key: neo4j-password
                - name: DELAY_MS
                  valueFrom:
                    configMapKeyRef:
                      name: {{ .Release.Name }}-config
                      key: delay-ms
                - name: USERS_TO_AUDIT
                  valueFrom:
                    configMapKeyRef:
                      name: {{ .Release.Name }}-config
                      key: users-to-audit
                - name: SKIP_SHAREPOINT
                  valueFrom:
                    configMapKeyRef:
                      name: {{ .Release.Name }}-config
                      key: skip-sharepoint
              resources:
                {{- toYaml .Values.collector.resources | nindent 16 }}
